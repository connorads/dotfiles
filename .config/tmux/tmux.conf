##### Minimal, portable tmux config (close to defaults) #####

# Faster Escape handling (helps vim/vi feel snappier inside tmux)
set -sg escape-time 50

# Big scrollback (useful on servers)
set -g history-limit 200000

# Mouse: scroll, select panes, resize panes
# If you hate mouse behaviour later, set this to "off".
set -g mouse on

# Make the status bar more readable and include session/window info + host/time
set -g status-interval 5

# Colours (VSCode Dark+ palette, Powerline style)
set -g status-style "bg=#1f1f1f,fg=#cccccc"

# Left: session name with Powerline arrow
set -g status-left "#[bg=#569cd6,fg=#1f1f1f,bold] #S #[bg=#2d2d2d,fg=#569cd6]#[fg=#9cdcfe] #{?window_zoomed_flag,,}#P/#{window_panes} #[bg=#1f1f1f,fg=#2d2d2d]"
set -g status-left-length 40

# Right: cpu/ram + git branch (dirty indicator) + hostname + time
set -g status-right "#[fg=#2d2d2d]#[bg=#2d2d2d,fg=#e06c75,bold] #{cpu_percentage} #[fg=#3d3d3d]#[bg=#3d3d3d,fg=#c678dd,bold] #{ram_percentage} #[fg=#4d4d4d]#[bg=#4d4d4d,fg=#6a9955]  #(cd #{pane_current_path}; git rev-parse --abbrev-ref HEAD 2>/dev/null || echo '-')#(cd #{pane_current_path}; git diff --quiet 2>/dev/null && git diff --cached --quiet 2>/dev/null || echo ' *') #[fg=#569cd6]#[bg=#569cd6,fg=#1f1f1f,bold] #h #[bg=#4fc1ff,fg=#1f1f1f,bold] %H:%M "
set -g status-right-length 120

# Window tabs (Powerline pill style)
set -g window-status-format "#[fg=#1f1f1f,bg=#2d2d2d]#[fg=#808080]#I #W #{b:pane_current_path}#[fg=#2d2d2d,bg=#1f1f1f]"
set -g window-status-current-format "#[fg=#1f1f1f,bg=#3d3d3d]#[fg=#d7ba7d,bold]#I #W #{b:pane_current_path}#[fg=#3d3d3d,bg=#1f1f1f]"
set -g window-status-separator " "

# Pane borders
set -g pane-border-style "fg=#2d2d2d"
set -g pane-active-border-style "fg=#569cd6"
set -g pane-border-lines heavy

# Base indexes start at 1 (nicer than 0 for humans)
set -g base-index 1
setw -g pane-base-index 1

##### Keybinds (still using default prefix Ctrl-b) #####

# Reload config quickly
bind r source-file ~/.config/tmux/tmux.conf \; display-message "tmux.conf reloaded"

# More mnemonic splits:
# - '|' = vertical split (side-by-side)
# - '-' = horizontal split (top/bottom)
unbind %
unbind '"'
bind | split-window -h
bind - split-window -v

# Vim-style pane navigation (prefix + h/j/k/l)
bind h select-pane -L
bind j select-pane -D
bind k select-pane -U
bind l select-pane -R

# Window switching without prefix (Alt + { / })
unbind -n M-[
unbind -n M-]
bind -n "M-{" previous-window
bind -n "M-}" next-window

# Last window toggle
bind Tab last-window

# Pane navigation without prefix (Ctrl + h/j/k/l, vim-tmux-navigator aware)
is_vim="ps -o state= -o comm= -t '#{pane_tty}' | grep -iqE '^[^TXZ ]+ +(\\S+\\/)?g?\.?(view|l?n?vim?x?|fzf|lazygit)(diff)?(-wrapped)?$'"
bind -n C-h if-shell "$is_vim" 'send-keys C-h' 'select-pane -L'
bind -n C-j if-shell "$is_vim" 'send-keys C-j' 'select-pane -D'
bind -n C-k if-shell "$is_vim" 'send-keys C-k' 'select-pane -U'
bind -n C-l if-shell "$is_vim" 'send-keys C-l' 'select-pane -R'
bind -T copy-mode-vi C-h select-pane -L
bind -T copy-mode-vi C-j select-pane -D
bind -T copy-mode-vi C-k select-pane -U
bind -T copy-mode-vi C-l select-pane -R

# Optional: create windows/panes in the current working directory
# (tmux 1.9+; widely available, but comment out if you hit issues)
bind c new-window -c "#{pane_current_path}"
bind | split-window -h -c "#{pane_current_path}"
bind - split-window -v -c "#{pane_current_path}"

# fzf session picker (prefix + S)
bind S display-popup -E "tmux list-sessions -F '#{session_name}' | fzf --reverse --header='Switch session' | xargs -I{} tmux switch-client -t {}"

# fzf window picker (prefix + W)
bind W display-popup -E "tmux list-windows -a -F '#{session_name}:#{window_index} #{window_name}' | fzf --reverse --header='Switch window' | cut -d' ' -f1 | xargs -I{} tmux switch-client -t {}"

# Lazygit in popup (prefix + g)
bind g display-popup -E -h 90% -w 90% -d "#{pane_current_path}" \
  'sh -c "if [ \"$PWD\" = \"$HOME\" ]; then exec lazygit --git-dir=\"$HOME/git/dotfiles\" --work-tree=\"$HOME\"; else exec lazygit; fi"'

##### SSH agent forwarding #####

# Pick up new SSH_AUTH_SOCK on reattach
set -g update-environment "SSH_AUTH_SOCK"

##### Quality-of-life #####

# Renumber windows when one is closed (keeps numbers tidy)
set -g renumber-windows on

# Don't delay after hitting prefix
set -g repeat-time 300

##### Clipboard (OSC 52) #####

# Enable copy to local clipboard over SSH via OSC 52 escape sequence
# Works with kitty, lazygit, neovim, and other OSC 52-aware tools
set -s set-clipboard on
# On: allow passthrough for visible pane only (tmux 3.3+). Needed for
# image protocols (kitty/sixel) in yazi etc. Safe: only the active pane can emit.
set -g allow-passthrough on

##### Help popup #####

# Show custom keybindings help (Ctrl+b ?)
bind-key ? display-popup -E -w 60 -h 30 'gum pager <<EOF
  WINDOWS
  Alt+{/}          prev/next window
  Ctrl+b 1-9       go to window N
  Ctrl+b Tab       last window
  Ctrl+b c         new window
  Ctrl+b ,         rename window
  Ctrl+b &         kill window

  PANES
  Ctrl+h/j/k/l     navigate panes (works across nvim)
  Ctrl+b |         split vertical
  Ctrl+b -         split horizontal
  Ctrl+b z         zoom pane
  Ctrl+d           close pane (exit shell)
  Ctrl+b x         kill pane

  POPUPS
  Ctrl+b S         fzf session picker
  Ctrl+b W         fzf window picker
  Ctrl+b g         lazygit (dotfiles if in ~)
  Ctrl+b Space     thumbs (quick-copy URLs/paths/hashes)
  Ctrl+b e         extrakto (fzf text from pane/scrollback)

  OTHER
  Ctrl+b d         detach
  Ctrl+b [         scroll/copy mode
  Ctrl+b r         reload config
  Ctrl+b ?         this help

  Mouse: click, scroll, drag borders
EOF
'

##### Plugins (TPM) #####

set -g @plugin 'tmux-plugins/tpm'
set -g @plugin 'tmux-plugins/tmux-resurrect'
set -g @plugin 'tmux-plugins/tmux-continuum'
set -g @plugin 'fcsonline/tmux-thumbs'
set -g @plugin 'laktak/extrakto'
set -g @plugin 'joshmedeski/tmux-nerd-font-window-name'
set -g @plugin 'tmux-plugins/tmux-cpu'

# tmux-thumbs settings
set -g @thumbs-key Space
set -g @thumbs-alphabet colemak-homerow
set -g @thumbs-command 'tmux set-buffer -w -- "{}" \; display-message "Copied: {}"'
set -g @thumbs-upcase-command 'tmux set-buffer -w -- "{}" \; paste-buffer \; display-message "Pasted: {}"'

# extrakto settings
set -g @extrakto_key 'e'
set -g @extrakto_copy_key 'tab'
set -g @extrakto_insert_key 'enter'
set -g @extrakto_clip_tool_run 'tmux_osc52'

# Auto-restore sessions on tmux start
set -g @continuum-restore 'on'

# Initialize TPM (keep at very end of config)
run '~/.config/tmux/plugins/tpm/tpm'

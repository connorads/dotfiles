##### tmux config #####
# NOTE: When adding/changing keybindings, also update ~/.config/tmux/help.md

# TODO: revisit after tmux includes the fixes discussed in:
# - https://github.com/tmux/tmux/issues/4793
# - https://github.com/anomalyco/opentui/issues/490
# Workaround: slightly higher timeout reduces stray hex/rgb fragments seen
# around OpenCode startup/exit on tmux 3.6/3.6a while staying responsive.
set -sg escape-time 30

# True colour (RGB) support - needed for editors like micro, neovim
set -as terminal-features ',tmux-256color:RGB'
set -as terminal-overrides ',*:Tc'

# Extended keys (tmux 3.2+) - helps pass modifier combos to apps
# Note: Shift+Enter doesn't work reliably through tmux+kitty; use Alt+Enter
# for newlines in Claude Code / OpenCode instead
set -s extended-keys always
set -s extended-keys-format csi-u
set -as terminal-features 'xterm*:extkeys'

# Forward pane/window titles to outer terminal
set -g set-titles on

# Big scrollback (useful on servers)
set -g history-limit 200000

# Mouse: scroll, select panes, resize panes
# If you hate mouse behaviour later, set this to "off".
set -g mouse on
# pane-scrollbars (3.6+) causes rendering glitches when scrolling - don't enable

# Make the status bar more readable and include session/window info + host/time
set -g status-interval 5

# Colours (Catppuccin Mocha palette, Powerline style)
set -g status-style "bg=#1e1e2e,fg=#cdd6f4"

# Left: session name with Powerline arrow (full >= 80, compact >= 50, ultra < 50)
set -g status-left "#{?#{e|>=:#{client_width},80},#[bg=#89b4fa]#[fg=#1e1e2e]#[bold]  #S #{?window_zoomed_flag,#[bg=#f38ba8]#[fg=#89b4fa]#[fg=#1e1e2e]  #P/#{window_panes} #[bg=#1e1e2e]#[fg=#f38ba8],#[bg=#313244]#[fg=#89b4fa]#[fg=#94e2d5]  #P/#{window_panes} #[bg=#1e1e2e]#[fg=#313244]},#{?#{e|>=:#{client_width},50},#[bg=#89b4fa]#[fg=#1e1e2e]#[bold] #S #[bg=#1e1e2e]#[fg=#89b4fa]#{?window_zoomed_flag,#[bg=#f38ba8]#[fg=#89b4fa]#[fg=#1e1e2e]#[bold]  #[bg=#1e1e2e]#[fg=#f38ba8],},#[bg=#89b4fa]#[fg=#1e1e2e]#[bold] #{=4:#S}#[bg=#1e1e2e]#[fg=#89b4fa]#{?window_zoomed_flag,#[bg=#f38ba8]#[fg=#89b4fa]#[fg=#1e1e2e]#[bold]  #[bg=#1e1e2e]#[fg=#f38ba8],}}}"
set -g status-left-length 50

# Right: responsive per-client via #{client_width}
#   >= 120: full (cpu, ram, disk, git, host, mode, time)
#   90-119: medium (git, host, mode, time)
#   60-89:  compact (host + time)
#   < 60:   mobile (time only)
set -g status-right "#(~/.config/tmux/scripts/status-right.sh \"#{client_width}\" \"#{pane_current_path}\" \"#{host_short}\" \"#{host}\" \"#{@hostname_full}\") #{?#{e|>=:#{client_width},60},#{tmux_mode_indicator},}#[bg=#94e2d5]#[fg=#1e1e2e]#[bold] %H:%M "
set -g status-right-length 180

##### Mode indicator + suspend (inline) #####

set -g @mode_indicator_prefix_mode_style "bg=#89b4fa,fg=#1e1e2e"
set -g @mode_indicator_copy_mode_style "bg=#f9e2af,fg=#1e1e2e"
set -g @mode_indicator_sync_mode_style "bg=#f38ba8,fg=#1e1e2e"
set -g @mode_indicator_ssh_mode_style "bg=#f38ba8,fg=#1e1e2e"
set -g @mode_indicator_empty_mode_style "bg=#b4befe,fg=#1e1e2e"

set -g @suspend_suspended_options " \
  @mode_indicator_custom_prompt:: SUSPEND , \
  @mode_indicator_custom_mode_style::bg=#45475a\\,fg=#1e1e2e \
"

# Suspend/resume key (global, no prefix)
set -g @suspend_key 'F10'

run-shell "~/.config/tmux/tmux-mode-indicator.tmux"
run-shell "~/.config/tmux/tmux-suspend.tmux"

# Window tabs (Powerline pill style, red when SSH/tailscale, paths hidden < 60 cols)
set -g window-status-format "#{?#{e|>=:#{client_width},60},#[fg=#1e1e2e#,bg=#313244]#[fg=#6c7086]#I #W #{=10:#{b:pane_current_path}}#[fg=#313244#,bg=#1e1e2e],#[fg=#1e1e2e#,bg=#313244]#[fg=#6c7086]#I #W #[fg=#313244#,bg=#1e1e2e]}"
set -g window-status-current-format "#{?#{&&:#{||:#{m:ssh,#{pane_current_command}},#{m:tailscale,#{pane_current_command}}},#{!=:#{client_key_table},suspended}},#[fg=#1e1e2e#,bg=#f38ba8]#[fg=#1e1e2e#,bold] #I  #W#{?#{e|>=:#{client_width},60}, #{=15:#{b:pane_current_path}},} #[fg=#f38ba8#,bg=#1e1e2e],#[fg=#1e1e2e#,bg=#45475a]#[fg=#f9e2af#,bold]#I #W#{?#{e|>=:#{client_width},60}, #{=15:#{b:pane_current_path}},}#[fg=#45475a#,bg=#1e1e2e]}"
set -g window-status-separator " "

# Pane borders
set -g pane-border-style "fg=#313244"
set -g pane-active-border-style "fg=#89b4fa"
set -g pane-border-lines heavy

# Popup borders — rounded frame with catppuccin blue, slight contrast on bg
set -g popup-border-lines rounded
set -g popup-border-style "fg=#89b4fa"
set -g popup-style "bg=#181825"

# Base indexes start at 1 (nicer than 0 for humans)
set -g base-index 1
setw -g pane-base-index 1

##### Keybinds (still using default prefix Ctrl-b) #####

# Reload config quickly
bind -N "Reload config" r source-file ~/.config/tmux/tmux.conf \; display-message "tmux.conf reloaded"

# Toggle full hostname in status bar
bind -N "Toggle full hostname" H if -F '#{@hostname_full}' 'set -gu @hostname_full' 'set -g @hostname_full 1' \; display-message "Hostname: #{?@hostname_full,full,short}"

# Vim-style pane navigation (prefix + h/j/k/l)
bind -N "Select pane left" h select-pane -L
bind -N "Select pane down" j select-pane -D
bind -N "Select pane up" k select-pane -U
bind -N "Select pane right" l select-pane -R

# Clear screen (Ctrl+l is taken by pane nav, use prefix + Ctrl+l)
bind -N "Clear screen" C-l send-keys 'C-l'

# Window switching without prefix (Alt + Shift + h/l)
bind -N "Previous window" -n M-H previous-window
bind -N "Next window" -n M-L next-window
bind -T copy-mode-vi M-H previous-window
bind -T copy-mode-vi M-L next-window

# Last window toggle
bind -N "Last window" Tab last-window

# Zoom-aware window/pane switching (works with webmux swipe gestures)
# When zoomed: cycle to next/prev pane and re-zoom; otherwise switch windows
bind -N "Next window (zoom-aware)" n if -F '#{window_zoomed_flag}' 'select-pane -t :.+ ; resize-pane -Z' 'next-window'
bind -N "Previous window (zoom-aware)" p if -F '#{window_zoomed_flag}' 'select-pane -t :.- ; resize-pane -Z' 'previous-window'

# Pane navigation without prefix (Ctrl + h/j/k/l, smart-splits.nvim aware)
bind -n C-h if -F "#{@pane-is-vim}" 'send-keys C-h' 'select-pane -L'
bind -n C-j if -F "#{@pane-is-vim}" 'send-keys C-j' 'select-pane -D'
bind -n C-k if -F "#{@pane-is-vim}" 'send-keys C-k' 'select-pane -U'
bind -n C-l if -F "#{@pane-is-vim}" 'send-keys C-l' 'select-pane -R'
bind -T copy-mode-vi C-h select-pane -L
bind -T copy-mode-vi C-j select-pane -D
bind -T copy-mode-vi C-k select-pane -U
bind -T copy-mode-vi C-l select-pane -R

# Pane resize without prefix (Alt + h/j/k/l, smart-splits.nvim aware)
bind -n M-h if -F "#{@pane-is-vim}" 'send-keys M-h' 'resize-pane -L 3'
bind -n M-j if -F "#{@pane-is-vim}" 'send-keys M-j' 'resize-pane -D 3'
bind -n M-k if -F "#{@pane-is-vim}" 'send-keys M-k' 'resize-pane -U 3'
bind -n M-l if -F "#{@pane-is-vim}" 'send-keys M-l' 'resize-pane -R 3'

# Create windows/panes in the current working directory
bind -N "New window in cwd" c new-window -c "#{pane_current_path}"
bind -N "Split vertical in cwd" | split-window -h -c "#{pane_current_path}"
bind -N "Split horizontal in cwd" - split-window -v -c "#{pane_current_path}"

# Rearrange panes/windows
bind -N "Break pane into window" ! break-pane
bind -N "Join pane from picker (left/right)" \\ choose-tree -Zw "join-pane -h -s '%%'"
bind -N "Join pane from picker (top/bottom)" _ choose-tree -Zw "join-pane -v -s '%%'"
bind -N "Join all windows into panes (tiled)" J run-shell "~/.local/bin/tmjoin"
bind -N "Burst all panes into windows" B run-shell "~/.local/bin/tmburst"

# fzf session picker (prefix + S)
bind -N "Session picker (fzf)" S display-popup -E "tmux list-sessions -F '#{session_name}' | fzf --reverse --header='Switch session' | xargs -I{} tmux switch-client -t {}"

# fzf window picker (prefix + W)
bind -N "Window picker (fzf)" W display-popup -E "tmux list-windows -a -F '#{session_name}:#{window_index} #{window_name}' | fzf --reverse --header='Switch window' | cut -d' ' -f1 | xargs -I{} tmux switch-client -t {}"

# Lazygit in popup (prefix + g)
bind -N "Lazygit" g display-popup -E -h 98% -w 98% -d "#{pane_current_path}" \
  'zsh -ic "if [[ $PWD == $HOME ]]; then lazygit --git-dir=$HOME/git/dotfiles --work-tree=$HOME; else lazygit; fi"'

# Difftastic git diff in popup (prefix + D)
bind -N "Difftastic git diff" D display-popup -E -h 98% -w 98% -d "#{pane_current_path}" \
  'sh -c "if [ \"$PWD\" = \"$HOME\" ]; then GIT_EXTERNAL_DIFF=\"difft --color=always\" git --git-dir=\"$HOME/git/dotfiles\" --work-tree=\"$HOME\" diff --color=always | less -R --mouse; else GIT_EXTERNAL_DIFF=\"difft --color=always\" git diff --color=always | less -R --mouse; fi"'

# Critique git diff in popup (prefix + C)
bind -N "Critique git diff" C run-shell '~/.config/tmux/scripts/critique-popup.sh "#{pane_current_path}"'

# Critique AI review in popup (prefix + R)
bind -N "Critique AI review" R command-prompt -I "opencode" -p "Critique agent (opencode|claude)" "run-shell '~/.config/tmux/scripts/critique-popup.sh \"#{pane_current_path}\" review %%'"

# gh-dash in popup (prefix + G)
bind -N "gh-dash" G display-popup -E -h 98% -w 98% -d "#{pane_current_path}" \
  'sh -c "if [ \"$PWD\" = \"$HOME\" ]; then GIT_DIR=\"$HOME/git/dotfiles\" GIT_WORK_TREE=\"$HOME\" exec gh dash; else exec gh dash; fi"'

# Yazi in popup (prefix + y) — nested session for passthrough support
bind -N "Yazi file manager" y display-popup -E -h 98% -w 98% -d "#{pane_current_path}" \
  'tmux new-session -A -s popup-yazi yazi \; set status off'

# Open pane cwd in native file manager (prefix + O)
bind -N "Open in file manager" O run-shell 'if [ "$(uname)" = "Darwin" ]; then open "#{pane_current_path}"; else xdg-open "#{pane_current_path}" 2>/dev/null; fi'

# Neovim in popup (prefix + v)
bind -N "Neovim" v display-popup -E -h 98% -w 98% -d "#{pane_current_path}" nvim

# Neovim help in popup (prefix + V)
bind -N "Neovim help" V display-popup -E -w 80 -h 40 \
  'PAGER="less -R --mouse" glow -p -s dark ~/.config/nvim/help.md'

# Function/alias search (prefix + f)
bind -N "Function/alias search" f display-popup -E -h 98% -w 98% 'zsh -ic "fns"'

# Port inspector with kill mode (prefix + P)
bind -N "Port inspector" P display-popup -E -h 98% -w 98% 'zsh -ic "ports -k"'

# Tailscale serve: status (Alt+t) / expose (T) / teardown (Alt+T)
bind -N "Tailscale serve status" M-t display-popup -E -h 20 -w 80 'zsh -ic "tsserve; echo; read -sk1"'
bind -N "Tailscale serve" T display-popup -E -h 98% -w 98% 'zsh -ic "tsserveup"'
bind -N "Tailscale serve down" M-T display-popup -E -h 98% -w 98% 'zsh -ic "tsservedown"'

# Process closer (prefix + K / prefix + Alt+Shift+K for sudo)
bind -N "Process closer (user)" K display-popup -E -h 98% -w 98% 'zsh -ic "pclose"'
bind -N "Process closer (sudo)" M-K display-popup -E -h 98% -w 98% 'zsh -ic "pclose --sudo"'

# System monitor — bottom (prefix + b)
bind -N "System monitor (bottom)" b display-popup -E -h 98% -w 98% btm

# AI usage (prefix + a)
bind -N "AI usage" a display-popup -E -h 15 -w 50 'zsh -ic "ai-usage; read -sk1 \?\"press any key\""'

# Layout presets picker (prefix + L) — reads from ~/.config/tmux/layouts/*.conf
bind -N "Layout presets" L display-popup -E "grep -h '^#' ~/.config/tmux/layouts/*.conf | sed 's/^# //' | fzf --reverse --header='Layout' | cut -d: -f1 | xargs -I{} tmux source-file ~/.config/tmux/layouts/{}.conf"

# Dynamic pane count (prefix + N) — prompt for total panes, then build two-row grid
bind -N "Create N two-row panes" N command-prompt -I "8" -p "Pane count" "run-shell 'sh ~/.config/tmux/scripts/layout-n.sh %% \"#{pane_id}\"'"

##### SSH agent forwarding #####

# Pick up new SSH_AUTH_SOCK on reattach
set -g update-environment "SSH_AUTH_SOCK"

# Fix stale agent symlink (prefix + F)
bind -N "Fix SSH agent" F run-shell 'sh ~/.config/tmux/scripts/fix-ssh-agent.sh && tmux display-message "SSH agent fixed"'

##### Quality-of-life #####

# Vi-style copy mode (enables copy-mode-vi bindings)
setw -g mode-keys vi

# Renumber windows when one is closed (keeps numbers tidy)
set -g renumber-windows on

# Don't delay after hitting prefix
set -g repeat-time 300

##### Reminders #####

# Show reminder (if set) on client attach
set-hook -g client-attached "run-shell -b 'sh ~/.config/tmux/reminder.sh'"

# Fix stale SSH agent symlink on reattach
set-hook -ga client-attached "run-shell -b 'sh ~/.config/tmux/scripts/fix-ssh-agent.sh'"

##### SSH visual cues (nested tmux safety) #####

# Refresh status bar on pane/window switch so mode indicator updates immediately
set-hook -g after-select-pane "refresh-client -S"
set-hook -g session-window-changed "refresh-client -S"

##### Clipboard (OSC 52) #####

# Enable copy to local clipboard over SSH via OSC 52 escape sequence
# Works with kitty, lazygit, neovim, and other OSC 52-aware tools
set -s set-clipboard on
# On: allow passthrough for visible pane only (tmux 3.3+). Needed for
# image protocols (kitty/sixel) in yazi etc. Safe: only the active pane can emit.
set -g allow-passthrough on

##### Help popup #####

# Show custom keybindings help (Ctrl+b ?)
bind-key -N "Help cheatsheet" ? display-popup -E -w 80 -h 40 \
  'PAGER="less -R --mouse" glow -p -s dark ~/.config/tmux/help.md'

# Search help with fzf (Ctrl+b /)
bind-key -N "Search help (fzf)" / display-popup -E -w 80 -h 40 \
  'grep -v "^$\|^#\|^|[-:]\|^| Key\|^Mouse" ~/.config/tmux/help.md | grep "|" | sed "s/^| //" | sed "s/ |$//" | fzf --reverse --header="Search keybindings" --preview-window=hidden'

##### Plugins (TPM) #####

# Plugins point at personal forks for supply chain safety — upstream authors
# can't push malicious code that `prefix + U` would blindly pull in.
# Tags are mutable so pinning them is not real protection; forks are.
#   Check for upstream updates:  tmux-upstream  (or -v for commit details)
#   Sync a fork after review:    gh repo sync connorads/<plugin> && prefix + U
set -g @plugin 'connorads/tpm'
set -g @plugin 'connorads/tmux-resurrect'
set -g @plugin 'connorads/tmux-continuum'
set -g @plugin 'connorads/tmux-thumbs'
set -g @plugin 'connorads/tmux-nerd-font-window-name'
set -g @plugin 'connorads/tmux-cpu'
set -g @plugin 'connorads/tmux-fzf-links'

# tmux-thumbs settings
set -g @thumbs-key Space
set -g @thumbs-alphabet colemak-homerow
set -g @thumbs-command 'tmux set-buffer -w -- "{}" \; display-message "Copied: {}"'
set -g @thumbs-upcase-command 'tmux set-buffer -w -- "{}" \; paste-buffer \; display-message "Pasted: {}"'

# fzf-links settings (URLs → browser, files → editor, images → Preview/xdg-open)
set -g @fzf-links-key u
set -g @fzf-links-editor-open-cmd "tmux new-window -n 'edit' $EDITOR +%line '%file'"
set -g @fzf-links-history-lines 2000
set -g @fzf-links-user-schemes-path "~/.config/tmux/user_schemes.py"

# Session/process restoration
set -g @resurrect-processes 'btm lazygit "~claude" "~opencode"'
set -g @resurrect-strategy-nvim 'persistence'
set -g @resurrect-strategy-claude 'session_id'
set -g @resurrect-strategy-opencode 'session_id'
set -g @resurrect-capture-pane-contents 'on'
set -g @resurrect-hook-post-save-layout '~/.config/tmux/scripts/resurrect-strip-nix-paths.sh $1 && ~/.config/tmux/scripts/resurrect-save-sessions.sh $1'

# Manual restore workflow (no auto-restore on startup):
#   Save:    prefix + Ctrl-s
#   Restore: prefix + Ctrl-r
set -g @continuum-save-interval '5'
set -g @continuum-restore 'off'
set-hook -gu session-closed

# CPU/RAM percentage format (no decimals)
set -g @cpu_percentage_format "%2.0f%%"
set -g @ram_percentage_format "%2.0f%%"

# Sync custom resurrect strategies into plugin dir (survives TPM updates)
run-shell 'cp ~/.config/tmux/strategies/*.sh ~/.config/tmux/plugins/tmux-resurrect/strategies/ 2>/dev/null || true'

# Initialize TPM (keep at very end of config)
run '~/.config/tmux/plugins/tpm/tpm'

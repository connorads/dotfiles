#!/usr/bin/env zsh
# up: update tools, flake lock, and rebuild for current OS
# flags: --skip-flake / -s  skip nix flake update and commit
emulate -L zsh

local skip_flake=0
for arg in "$@"; do
  case "$arg" in
    --skip-flake|-s) skip_flake=1 ;;
  esac
done

mise upgrade
if [[ "$OSTYPE" == "darwin"* ]]; then
  brew update && brew upgrade
fi

# apt updates (non-NixOS Linux)
if [[ "$OSTYPE" == "linux-gnu"* ]] && command -v apt-get &>/dev/null && [[ ! -f /etc/NIXOS ]]; then
  echo "=> apt update + upgrade"
  sudo apt-get update -y
  sudo env DEBIAN_FRONTEND=noninteractive apt-get upgrade -y
  sudo env DEBIAN_FRONTEND=noninteractive apt-get autoremove -y
fi

if (( !skip_flake )); then
  nfu
  dotfiles add ~/.config/nix/flake.lock
  if ! dotfiles diff --cached --quiet -- ~/.config/nix/flake.lock; then
    dotfiles commit -m "chore(nix): update flake lock"
  fi
fi

if [[ "$OSTYPE" == "darwin"* ]]; then
  drs
elif [[ "$OSTYPE" == "linux-gnu"* ]]; then
  hms
fi

# Reboot notification (apt-based Linux)
if [[ "$OSTYPE" == "linux-gnu"* ]] && [[ -f /var/run/reboot-required ]]; then
  echo ""
  echo "*** Reboot required ***"
  cat /var/run/reboot-required.pkgs 2>/dev/null
  echo "Run: sudo reboot"
fi

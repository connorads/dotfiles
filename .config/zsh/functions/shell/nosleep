#!/usr/bin/env zsh
# nosleep: keep mac awake (prevents system sleep on AC power)
emulate -L zsh

if ! command -v caffeinate >/dev/null 2>&1; then
  print -u2 "caffeinate not found (macOS only)"
  return 1
fi

if [[ "$1" == "--help" || "$1" == "-h" ]]; then
  echo "Usage: nosleep [duration] [-- command...]"
  echo "  Prevents system sleep on AC power (caffeinate -s)"
  echo "  Duration: 30, 5m, 2h"
  echo "  Command:  nosleep -- long-running-task"
  return 0
fi

if [[ $# -eq 0 ]]; then
  caffeinate -s
  return $?
fi

local duration="$1"
local seconds=""

if [[ "$duration" =~ ^[0-9]+$ ]]; then
  seconds="$duration"
elif [[ "$duration" =~ ^([0-9]+)([smh])$ ]]; then
  local value="${match[1]}"
  local unit="${match[2]}"
  case "$unit" in
    s) seconds="$value" ;;
    m) seconds="$(( value * 60 ))" ;;
    h) seconds="$(( value * 3600 ))" ;;
  esac
fi

if [[ -n "$seconds" ]]; then
  shift
  if [[ $# -eq 0 ]]; then
    caffeinate -s -t "$seconds"
  else
    caffeinate -s -t "$seconds" "$@"
  fi
  return $?
fi

caffeinate -s "$@"

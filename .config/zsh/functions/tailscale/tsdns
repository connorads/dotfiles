#!/usr/bin/env zsh
# tsdns: manage Tailscale DNS preference on this device
emulate -L zsh
setopt localoptions

local usage="Usage: tsdns [status|info|on|off|toggle]"
local action="${1:-status}"
local prefs compact

if [[ $# -gt 1 ]]; then
  print -u2 "$usage"
  return 1
fi

case "$action" in
  -h|--help|help)
    echo "$usage"
    return 0
    ;;
  status|info|on|off|toggle)
    ;;
  *)
    print -u2 "$usage"
    return 1
    ;;
esac

if [[ "$action" == on ]]; then
  ts set --accept-dns=true || return 1
elif [[ "$action" == off ]]; then
  ts set --accept-dns=false || return 1
elif [[ "$action" == toggle ]]; then
  prefs="$(ts debug prefs 2>/dev/null)" || {
    print -u2 "Could not read Tailscale preferences. Is tailscaled running?"
    return 1
  }
  compact="${prefs//[[:space:]]/}"
  if [[ "$compact" == *'"CorpDNS":true'* ]]; then
    ts set --accept-dns=false || return 1
  elif [[ "$compact" == *'"CorpDNS":false'* ]]; then
    ts set --accept-dns=true || return 1
  else
    print -u2 "Could not determine current Tailscale DNS setting"
    return 1
  fi
fi

prefs="$(ts debug prefs 2>/dev/null)" || {
  print -u2 "Could not read Tailscale preferences. Is tailscaled running?"
  return 1
}
compact="${prefs//[[:space:]]/}"

if [[ "$compact" == *'"CorpDNS":true'* ]]; then
  echo "Tailscale DNS: on (accept-dns=true)"
elif [[ "$compact" == *'"CorpDNS":false'* ]]; then
  echo "Tailscale DNS: off (accept-dns=false)"
else
  echo "Tailscale DNS: unknown"
fi

if [[ "$action" == status ]]; then
  echo "Use: tsdns on | off | toggle | info"
fi

if [[ "$action" == info ]]; then
  ts dns status
fi

#!/usr/bin/env zsh
# tsssh: manage Tailscale SSH preference on this device
emulate -L zsh
setopt localoptions

local usage="Usage: tsssh [status|on|off|toggle]"
local action="${1:-status}"
local prefs compact

if [[ $# -gt 1 ]]; then
  echo "$usage" >&2
  return 1
fi

case "$action" in
  -h|--help|help)
    echo "$usage"
    return 0
    ;;
  status|on|off|toggle)
    ;;
  *)
    echo "$usage" >&2
    return 1
    ;;
esac

if [[ "$action" == on ]]; then
  ts set --ssh=true || return 1
elif [[ "$action" == off ]]; then
  ts set --ssh=false || return 1
elif [[ "$action" == toggle ]]; then
  prefs="$(ts debug prefs 2>/dev/null)" || {
    echo "Could not read Tailscale preferences. Is tailscaled running?" >&2
    return 1
  }
  compact="${prefs//[[:space:]]/}"
  if [[ "$compact" == *'"RunSSH":true'* ]]; then
    ts set --ssh=false || return 1
  elif [[ "$compact" == *'"RunSSH":false'* ]]; then
    ts set --ssh=true || return 1
  else
    echo "Could not determine current Tailscale SSH setting" >&2
    return 1
  fi
fi

prefs="$(ts debug prefs 2>/dev/null)" || {
  echo "Could not read Tailscale preferences. Is tailscaled running?" >&2
  return 1
}
compact="${prefs//[[:space:]]/}"

if [[ "$compact" == *'"RunSSH":true'* ]]; then
  echo "Tailscale SSH: on (--ssh=true)"
elif [[ "$compact" == *'"RunSSH":false'* ]]; then
  echo "Tailscale SSH: off (--ssh=false)"
else
  echo "Tailscale SSH: unknown"
fi

if [[ "$action" == status ]]; then
  echo "Use: tsssh on | off | toggle"
fi
